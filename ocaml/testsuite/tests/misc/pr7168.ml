(* TEST

ocamlrunparam += "l=100000"
*)

let rec f x =
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in  let x = x+x in  let x = x+x in  let x = x+x in
  let x = x+x in
  let _ = f x in
  ()

let _ =
  (* CR ocaml 5 runtime: we should be able
   * to simplify this test along the same
   * lines as upstream, as stack overflow
   * detection is always supported in
  * ocaml 5. *)
  if (Gc.get ()).Gc.stack_limit = 0 then begin
    (* We are in native code. Skip the test because some platforms cannot
       reliably detect stack overflow. *)
    Printf.printf "OK\n"
  end else begin
    try Sys.with_async_exns (fun () -> f 1)
    with Stack_overflow -> Printf.printf "OK\n"
  end
